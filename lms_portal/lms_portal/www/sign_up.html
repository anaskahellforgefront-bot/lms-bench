{% extends "lms_portal/www/base.html" %}

{% block title %}Join LMS Elite{% endblock %}

{% block head_css %}
<style>
    /* Styling inherits from base.html variables */
    html { writing-mode: horizontal-tb; direction: ltr; }
    html[dir="rtl"] { direction: rtl; }
    
    .auth-wrapper { display: flex; min-height: calc(100vh - 76px); background: var(--bg-body); overflow-x: hidden; }
    html[dir="rtl"] .auth-wrapper { flex-direction: row-reverse; }

    .visual-side {
        flex: 1; position: relative; background: #0f172a;
        background-image: url('https://images.unsplash.com/photo-1524995997946-a1c2e315a42f?q=80&w=2340&auto=format&fit=crop');
        background-size: cover; background-position: center; display: none;
    }
    .visual-overlay {
        position: absolute; inset: 0; background: linear-gradient(to top, rgba(15, 23, 42, 0.95), rgba(37, 99, 235, 0.6));
        padding: 60px; color: white; display: flex; flex-direction: column; justify-content: flex-end;
    }

    .form-side { flex: 1.2; padding: 40px; display: flex; justify-content: center; align-items: center; background: var(--bg-surface); }
    .auth-card { width: 100%; max-width: 480px; opacity: 0; transform: translateY(20px); transition: 0.5s; }
    .auth-card.visible { opacity: 1; transform: translateY(0); }

    .step-section { display: none; animation: fadeIn 0.4s ease; }
    .step-section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* Inputs with Icons */
    .input-group-elite { position: relative; margin-bottom: 20px; }
    .input-elite {
        width: 100%; height: 54px; padding: 0 20px; border: 1px solid var(--border-color);
        background: var(--bg-body); border-radius: var(--radius-md); font-size: 1rem; color: var(--text-main);
        transition: 0.3s;
    }
    .input-elite:focus { border-color: var(--brand-color); box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1); }
    
    .toggle-pass {
        position: absolute; top: 50%; inset-inline-end: 15px; transform: translateY(-50%);
        color: var(--text-muted); cursor: pointer; transition: 0.2s; z-index: 10;
    }
    .toggle-pass:hover { color: var(--brand-color); }

    /* OTP Grid */
    .otp-grid { display: flex; gap: 10px; justify-content: center; margin-bottom: 25px; }
    .otp-char {
        width: 50px; height: 50px; text-align: center; font-size: 1.5rem; font-weight: 700;
        border: 2px solid var(--border-color); border-radius: 10px; background: var(--bg-surface);
        color: var(--text-main); transition: 0.2s;
    }
    .otp-char:focus { border-color: var(--brand-color); transform: translateY(-3px); }

    /* Timer Styles */
    .timer-wrapper { text-align: center; margin-top: 15px; font-size: 0.9rem; color: var(--text-muted); }
    .resend-link { color: var(--brand-color); font-weight: 700; cursor: pointer; display: none; }
    .resend-link:hover { text-decoration: underline; }

    /* New Password Meter (List Style) */
    .pwd-meter-list { 
        margin-bottom: 20px; background: var(--bg-body); padding: 15px; 
        border-radius: var(--radius-md); border: 1px solid var(--border-color); 
    }
    .pwd-req { 
        display: flex; align-items: center; gap: 10px; 
        font-size: 0.85rem; color: var(--text-muted); margin-bottom: 8px; 
        transition: 0.3s;
    }
    .pwd-req:last-child { margin-bottom: 0; }
    .pwd-req i { font-size: 0.6rem; color: var(--border-color); transition: 0.3s; }
    
    /* Valid State */
    .pwd-req.valid { color: #10B981; font-weight: 500; }
    .pwd-req.valid i { color: #10B981; transform: scale(1.2); }

    @media (min-width: 992px) { .visual-side { display: block; } }
</style>
{% endblock %}

{% block content %}
<div class="auth-wrapper">
    <div class="visual-side">
        <div class="visual-overlay">
            <h1 style="font-size: 3rem; font-weight: 800; line-height: 1;">Join the Elite.</h1>
            <p style="font-size: 1.2rem; opacity: 0.9; margin-top: 15px;">Access thousands of premium resources.</p>
        </div>
    </div>

    <div class="form-side">
        <div class="auth-card">
            
            <div style="margin-bottom: 30px;">
                <h2 style="font-size: 2rem; font-weight: 800;" data-i18n="h_create">Create Account</h2>
                <p style="color: var(--text-muted);"><span data-i18n="txt_step">Step</span> <span id="stepNum">1</span> <span data-i18n="txt_of">of</span> 3</p>
            </div>

            <div id="errorBox" style="display:none; color:white; background:#EF4444; padding:15px; border-radius:10px; margin-bottom:20px;"></div>

            <div id="step1" class="step-section active">
                <label style="font-weight:600; margin-bottom:8px; display:block;" data-i18n="lbl_name">Full Name</label>
                <div class="input-group-elite">
                    <input type="text" id="reg_name" class="input-elite" placeholder="e.g. Anas Ahmed" required>
                </div>

                <label style="font-weight:600; margin-bottom:8px; display:block;" data-i18n="lbl_email">Email Address</label>
                <div class="input-group-elite">
                    <input type="email" id="reg_email" class="input-elite" placeholder="name@example.com" required>
                </div>

                <button onclick="SignUp.sendOTP()" class="btn-elite btn-primary-glow w-100 py-3 justify-content-center" id="btnStep1">
                    <span data-i18n="btn_next_verify">Next: Verify Email</span> <i class="fas fa-arrow-right"></i>
                </button>
            </div>

            <div id="step2" class="step-section">
                <p style="margin-bottom:20px;"><span data-i18n="txt_sent_otp">We sent a 6-digit code to</span> <b id="displayEmail"></b></p>
                <div class="otp-grid">
                    <input type="text" maxlength="1" class="otp-char" onkeyup="SignUp.moveFocus(this, 1)">
                    <input type="text" maxlength="1" class="otp-char" onkeyup="SignUp.moveFocus(this, 2)">
                    <input type="text" maxlength="1" class="otp-char" onkeyup="SignUp.moveFocus(this, 3)">
                    <input type="text" maxlength="1" class="otp-char" onkeyup="SignUp.moveFocus(this, 4)">
                    <input type="text" maxlength="1" class="otp-char" onkeyup="SignUp.moveFocus(this, 5)">
                    <input type="text" maxlength="1" class="otp-char" onkeyup="SignUp.moveFocus(this, 6)">
                </div>
                
                <button onclick="SignUp.verifyCode()" class="btn-elite btn-primary-glow w-100 py-3 justify-content-center" id="btnStep2" data-i18n="btn_verify">Verify & Continue</button>
                
                <div class="timer-wrapper">
                    <span id="timerText"><span data-i18n="txt_resend_in">Resend code in</span> <b id="countDown">30</b>s</span>
                    <a class="resend-link" id="btnResend" onclick="SignUp.resendOTP()" data-i18n="btn_resend">Resend Code</a>
                </div>
                
                <button onclick="SignUp.resetSteps()" class="btn-elite btn-ghost w-100 py-2 mt-2 justify-content-center" style="border:none;" data-i18n="btn_wrong_email">Wrong Email?</button>
            </div>

            <div id="step3" class="step-section">
                <label style="font-weight:600; margin-bottom:8px; display:block;" data-i18n="lbl_create_pass">Create Password</label>
                
                <div class="input-group-elite">
                    <input type="password" id="reg_pass" class="input-elite" placeholder="••••••••" onkeyup="SignUp.checkPass()">
                    <i class="fas fa-eye toggle-pass" onclick="SignUp.toggleVisibility('reg_pass', this)"></i>
                </div>

                <label style="font-weight:600; margin-bottom:8px; display:block;" data-i18n="lbl_confirm_pass">Confirm Password</label>
                <div class="input-group-elite">
                    <input type="password" id="confirm_pass" class="input-elite" placeholder="••••••••" onkeyup="SignUp.checkPass()">
                    <i class="fas fa-eye toggle-pass" onclick="SignUp.toggleVisibility('confirm_pass', this)"></i>
                </div>
                
                <div class="pwd-meter-list">
                    <div class="pwd-req" id="req_len"><i class="fas fa-circle"></i> <span data-i18n="req_8_chars">8+ Characters</span></div>
                    <div class="pwd-req" id="req_upper"><i class="fas fa-circle"></i> <span data-i18n="req_upper">1 Uppercase Letter (A-Z)</span></div>
                    <div class="pwd-req" id="req_num"><i class="fas fa-circle"></i> <span data-i18n="req_num">1 Number (0-9)</span></div>
                    <div class="pwd-req" id="req_match"><i class="fas fa-circle"></i> <span data-i18n="req_match">Passwords Match</span></div>
                </div>

                <button onclick="SignUp.finish()" class="btn-elite btn-primary-glow w-100 py-3 justify-content-center" id="btnStep3" disabled>
                    <span data-i18n="btn_finish">Complete Registration</span> <i class="fas fa-check"></i>
                </button>
            </div>

            <div style="text-align: center; margin-top: 30px; font-size: 0.9rem;">
                <span data-i18n="txt_has_account">Already have an account?</span> 
                <a href="/sign_in" style="color:var(--brand-color); font-weight:700;" data-i18n="link_signin">Sign In</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
    if ("{{ frappe.session.user }}" !== "Guest") { window.location.href = "/library"; }

    const SignUp = {
        data: { email: '', name: '', otp: '' },
        timerInterval: null,
        
        dict: {
            'en': { 
                'h_create': 'Create Account', 'btn_next_verify': 'Next: Verify Email', 
                'btn_verify': 'Verify', 'btn_finish': 'Complete', 'lbl_name': 'Full Name',
                'lbl_email': 'Email Address', 'lbl_create_pass': 'Create Password',
                'lbl_confirm_pass': 'Confirm Password',
                'txt_step': 'Step', 'txt_of': 'of', 'txt_sent_otp': 'We sent a 6-digit code to',
                'btn_wrong_email': 'Wrong Email?', 'txt_has_account': 'Already have an account?',
                'link_signin': 'Sign In', 'txt_resend_in': 'Resend code in', 'btn_resend': 'Resend Code',
                // Requirements
                'req_8_chars': 'Minimum 8 characters',
                'req_upper': 'At least 1 Uppercase Letter',
                'req_num': 'At least 1 Number',
                'req_match': 'Passwords must match'
            },
            'ar': { 
                'h_create': 'إنشاء حساب', 'btn_next_verify': 'التالي: تفعيل البريد', 
                'btn_verify': 'تأكيد', 'btn_finish': 'إتمام التسجيل', 'lbl_name': 'الاسم الكامل',
                'lbl_email': 'البريد الإلكتروني', 'lbl_create_pass': 'كلمة المرور',
                'lbl_confirm_pass': 'تأكيد كلمة المرور',
                'txt_step': 'خطوة', 'txt_of': 'من', 'txt_sent_otp': 'أرسلنا الكود إلى',
                'btn_wrong_email': 'بريد خاطئ؟', 'txt_has_account': 'لديك حساب بالفعل؟',
                'link_signin': 'دخول', 'txt_resend_in': 'إعادة الإرسال خلال', 'btn_resend': 'إعادة إرسال الرمز',
                // Requirements
                'req_8_chars': '8 حروف على الأقل',
                'req_upper': 'حرف كبير واحد على الأقل',
                'req_num': 'رقم واحد على الأقل',
                'req_match': 'كلمات المرور متطابقة'
            }
        },

        init() {
            setTimeout(() => document.querySelector('.auth-card').classList.add('visible'), 50);
            this.applyLocalTranslations();
            window.addEventListener('lms-ui-update', (e) => this.applyLocalTranslations(e.detail.lang));
        },

        applyLocalTranslations(lang = null) {
            const currentLang = lang || localStorage.getItem('lms_lang') || 'en';
            const texts = this.dict[currentLang];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (texts[key]) {
                    if (el.tagName === 'INPUT') el.placeholder = texts[key];
                    else el.innerText = texts[key];
                }
            });
        },

        // --- ERROR HANDLING (Auto Clear) ---
        clearError() {
            document.getElementById('errorBox').style.display = 'none';
        },

        showError(msg) {
            const box = document.getElementById('errorBox');
            box.style.display = 'block'; box.innerText = msg;
            const card = document.querySelector('.auth-card');
            card.style.animation = 'none';
            setTimeout(() => card.style.animation = 'shake 0.5s', 10);
        },

        // --- UX HELPERS ---
        toggleVisibility(id, icon) {
            const input = document.getElementById(id);
            if(input.type === 'password') {
                input.type = 'text';
                icon.className = 'fas fa-eye-slash toggle-pass';
            } else {
                input.type = 'password';
                icon.className = 'fas fa-eye toggle-pass';
            }
        },

        startTimer() {
            let timeLeft = 30; 
            const countSpan = document.getElementById('countDown');
            const timerText = document.getElementById('timerText');
            const resendBtn = document.getElementById('btnResend');

            timerText.style.display = 'inline';
            resendBtn.style.display = 'none';
            countSpan.innerText = timeLeft;

            if(this.timerInterval) clearInterval(this.timerInterval);

            this.timerInterval = setInterval(() => {
                timeLeft--;
                countSpan.innerText = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(this.timerInterval);
                    timerText.style.display = 'none';
                    resendBtn.style.display = 'inline-block';
                }
            }, 1000);
        },

        moveFocus(el, i) {
            if(el.value.length >= 1) {
                const next = document.querySelector(`.otp-char:nth-child(${i+1})`);
                if(next) next.focus();
            }
        },

        // --- ACTIONS ---

        async sendOTP() {
            this.clearError(); // Clean slate
            const name = document.getElementById('reg_name').value;
            const email = document.getElementById('reg_email').value;
            const btn = document.getElementById('btnStep1');

            if(!name || !email) return this.showError("Please fill all fields.");
            
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
            
            try {
                const formData = new FormData();
                formData.append('email', email);
                formData.append('full_name', name);

                const response = await fetch('/api/method/lms_portal.www.sign_up.send_otp', {
                    method: 'POST',
                    headers: { 'X-Frappe-CSRF-Token': "{{ frappe.session.csrf_token }}" },
                    body: formData
                });

                if (response.ok) {
                    this.data.email = email; this.data.name = name;
                    document.getElementById('displayEmail').innerText = email;
                    this.switchStep('step2', 2);
                    this.startTimer(); 
                } else { throw new Error("Error"); }
            } catch (e) {
                this.showError("Failed to send OTP.");
                btn.disabled = false; btn.innerText = "Next: Verify Email";
            }
        },

        async resendOTP() {
            this.clearError();
            const resendBtn = document.getElementById('btnResend');
            resendBtn.innerText = "Sending...";
            
            try {
                const formData = new FormData();
                formData.append('email', this.data.email);
                formData.append('full_name', this.data.name);

                await fetch('/api/method/lms_portal.www.sign_up.send_otp', {
                    method: 'POST',
                    headers: { 'X-Frappe-CSRF-Token': "{{ frappe.session.csrf_token }}" },
                    body: formData
                });
                
                this.startTimer();
                const lang = localStorage.getItem('lms_lang') || 'en';
                resendBtn.innerText = this.dict[lang]['btn_resend'];

            } catch(e) { alert("Failed to resend"); }
        },

        async verifyCode() {
            this.clearError();
            let otp = ''; document.querySelectorAll('.otp-char').forEach(i => otp += i.value);
            if(otp.length < 6) return this.showError("Enter full 6-digit code.");
            
            const btn = document.getElementById('btnStep2');
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';

            try {
                const formData = new FormData();
                formData.append('email', this.data.email);
                formData.append('otp', otp);

                const response = await fetch('/api/method/lms_portal.www.sign_up.verify_otp', {
                    method: 'POST',
                    headers: { 'X-Frappe-CSRF-Token': "{{ frappe.session.csrf_token }}" },
                    body: formData
                });

                if (response.ok) {
                    this.data.otp = otp;
                    clearInterval(this.timerInterval); 
                    this.switchStep('step3', 3);
                } else { throw new Error("Invalid Code"); }
            } catch(e) {
                this.showError("Invalid or Expired Code.");
                btn.disabled = false; btn.innerText = "Verify & Continue";
            }
        },

        switchStep(id, num) {
            this.clearError();
            document.querySelectorAll('.step-section').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.getElementById('stepNum').innerText = num;
        },

        resetSteps() { location.reload(); },

        // --- NEW PASSWORD VALIDATION LOGIC ---
        checkPass() {
            const p = document.getElementById('reg_pass').value;
            const conf = document.getElementById('confirm_pass').value;
            
            // Rules
            const r_len = p.length >= 8;
            const r_upper = /[A-Z]/.test(p);
            const r_num = /\d/.test(p);
            const r_match = p.length > 0 && p === conf;

            // Update UI Icons
            this.updateReqUI('req_len', r_len);
            this.updateReqUI('req_upper', r_upper);
            this.updateReqUI('req_num', r_num);
            this.updateReqUI('req_match', r_match);

            // Enable Button Only if All True
            document.getElementById('btnStep3').disabled = !(r_len && r_upper && r_num && r_match);
        },

        updateReqUI(id, isValid) {
            const el = document.getElementById(id);
            const icon = el.querySelector('i');
            
            if(isValid) {
                el.classList.add('valid');
                icon.className = 'fas fa-check-circle';
            } else {
                el.classList.remove('valid');
                icon.className = 'fas fa-circle';
            }
        },

        async finish() {
            this.clearError();
            const btn = document.getElementById('btnStep3');
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
            
            try {
                const formData = new FormData();
                formData.append('email', this.data.email);
                formData.append('full_name', this.data.name);
                formData.append('otp', this.data.otp);
                formData.append('password', document.getElementById('reg_pass').value);
                
                const response = await fetch('/api/method/lms_portal.www.sign_up.create_account', {
                    method: 'POST',
                    headers: { 'X-Frappe-CSRF-Token': "{{ frappe.session.csrf_token }}" },
                    body: formData
                });

                if (response.ok) {
                    btn.innerHTML = 'Success! Redirecting...';
                    window.location.href = '/sign_in';
                } else {
                    const result = await response.json();
                    if(result._server_messages) {
                        const msgs = JSON.parse(result._server_messages);
                        throw new Error(JSON.parse(msgs[0]).message);
                    }
                    throw new Error("Failed");
                }
            } catch (e) {
                this.showError(e.message || "Password rejected by system.");
                btn.disabled = false; btn.innerText = "Complete Registration";
            }
        }
    };

    SignUp.init();
</script>
{% endblock %}